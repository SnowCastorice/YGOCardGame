
# 📋 TCG Pack Opener 项目全面总结

> **用途**：本文件是给新 AI 模型接手开发用的完整项目交接文档。
> **生成时间**：2026-02-15
> **当前版本**：v0.2.0

---

## 一、项目基本信息

| 项目 | 详情 |
|------|------|
| **项目名称** | TCG Pack Opener（卡包开封模拟器） |
| **当前版本** | v0.2.0 |
| **项目目标** | 复刻游戏王实体卡包的开包体验，后续添加电子游戏特有功能 |
| **技术栈** | 纯前端（HTML + CSS + JavaScript），无框架、无构建工具 |
| **部署方式** | GitHub + Cloudflare Pages 自动部署（已配置好，AI 只需编写代码） |
| **数据来源** | YGOProDeck API v7（离线时使用内置备用数据） |
| **工作目录** | `D:\TCGGame` |

---

## 二、用户身份与沟通要求

- 用户是**游戏策划**，代码水平较低，需要简单易懂的方式沟通
- 用户可能**移动办公**，在不同设备和不同 AI 模型间切换开发
- 因此要求**版本迭代信息记录完善**，网页内也要展示更新日志
- 用户愿意尝试新的实现方式和技术

---

## 三、项目目录结构

```
TCGGame/
├── index.html              ← 游戏主页面入口（117行）
├── css/
│   └── style.css           ← 全部样式 + 动画（758行）
├── js/
│   ├── api.js              ← API 调用 + 缓存管理模块（613行）
│   └── game.js             ← 游戏核心逻辑（555行）
├── data/
│   ├── cards.json          ← ⭐ 卡包配置表（策划编辑用）
│   ├── changelog.json      ← 更新日志数据
│   └── fallback_cards.js   ← 离线备用卡牌数据（3个卡包，约26KB）
├── VERSION.md              ← 项目说明与版本记录
├── 需求.txt                ← 原始需求文档
└── 项目总结.md             ← 本文件（交接用）
```

### 文件职责说明

| 文件 | 职责 |
|------|------|
| `js/api.js` | API 调用 + IndexedDB/Cache API 双缓存管理，暴露为 `window.TCG_API` 全局对象 |
| `js/game.js` | 游戏逻辑 + UI 控制（开包、抽卡、界面切换、弹窗等） |
| `data/cards.json` | **策划编辑**的卡包配置（卡包名、编码、概率、每包张数） |
| `data/changelog.json` | 更新日志数据，版本信息网页上展示 |
| `data/fallback_cards.js` | 离线备用数据，全局变量 `window.FALLBACK_CARD_DATA` |
| `index.html` | 页面结构，底部按顺序加载：`fallback_cards.js` → `api.js` → `game.js` |

---

## 四、核心需求与技术约束

### 技术约束（必须遵守）

1. **纯前端项目**，不引入后端服务，不使用框架，不使用构建工具
2. 部署在 **Cloudflare Pages**（通过 GitHub 自动部署），直接推送即可
3. 卡牌数据通过 **YGOProDeck API v7** 自动获取，策划**只需配置卡包信息**
4. **API 使用规范**：
   - 每秒 ≤20 次请求
   - 卡图必须缓存到本地，重复请求会导致 IP 封禁
   - 非商业用途
   - 需在页脚标注来源（YGOProDeck & Konami）
5. 每次版本更新需**同时**更新 `data/changelog.json` 和 `VERSION.md`

### 核心玩法需求

- 复刻**游戏王实体卡包**的开包体验（这是第一优先级）
- 后续添加电子游戏特有功能（连抽、天井等）

---

## 五、已完成功能（v0.1.0 → v0.2.0）

### v0.1.0 完成内容
- ✅ 项目基础结构搭建（HTML + CSS + JS 三层分离）
- ✅ 卡牌配置表系统（JSON 格式）
- ✅ 基础开包流程：选择卡包 → 开包动画 → 展示结果
- ✅ 稀有度系统：N / R / SR / UR 四个等级
- ✅ 更新日志弹窗
- ✅ 适配 Cloudflare Pages 部署

### v0.2.0 完成内容
- ✅ 接入 YGOProDeck API，自动获取真实游戏王卡牌数据和卡图
- ✅ 实现 IndexedDB + Cache API 双缓存系统
  - IndexedDB（`TCGPackOpener` 数据库）— 存储卡牌数据，过期时间 7 天
  - Cache API（`tcg-card-images`）— 缓存卡牌图片，过期时间 30 天
- ✅ 卡包配置改为使用官方卡包编码，无需手动填写卡牌
- ✅ 新增保底机制（每包最后一张至少 R 稀有度）
- ✅ 新增缓存管理界面（查看 / 清除缓存）
- ✅ 新增全局加载状态提示
- ✅ 添加版权声明（YGOProDeck & Konami）
- ✅ 离线备用数据（3 个卡包，API 不可用时自动降级）
- ✅ 初始配置 3 个经典卡包：传说之蓝眼白龙、金属侵略者、法老的仆从
- ✅ 移动端响应式适配

---

## 六、待开发功能（规划中，未排优先级）

| 功能 | 说明 |
|------|------|
| 收藏系统 / 图鉴 | 记录已抽到的卡牌 |
| 更丰富的开包动画 | 当前动画较简单（1.5秒 emoji 抖动 + 发光），需要更接近实体卡包的撕开体验 |
| 连抽 / 天井 | 电子游戏特有的抽卡机制 |
| 卡包商店系统 | 待详细设计 |
| 音效系统 | 开包、抽到稀有卡等音效 |
| 卡牌详情弹窗 | 点击查看大图和效果描述 |

---

## 七、现存问题与风险

### 🔴 代码/架构问题

1. **稀有度映射可能不准确**
   - `api.js` 中的 `mapRarityToCode()` 用简单字符串 `includes()` 匹配
   - "Short Print"、"Starfoil Rare" 等特殊稀有度会被错误归为 N
   - 条件 `name.includes('rare') && !name.includes('common')` 可能误判

2. **API 卡包匹配逻辑有隐患**
   - `getCardSetData()` 中查找卡牌在卡包中的稀有度时的匹配条件：
     ```javascript
     s.set_name === setCode || s.set_code.startsWith(setCode)
     ```
   - `setCode` 是卡包全名（如 "Legend of Blue Eyes White Dragon"），而 `s.set_code` 是类似 "LOB-001" 的编码，`startsWith` 匹配逻辑不合理

3. **无游戏进度持久化**
   - 目前只缓存了卡牌数据，没有保存玩家的开包记录 / 收藏

4. **卡名全部是英文**
   - API 只返回英文名，代码中 `nameCN` 字段只是复制了英文名，中文化未实现

5. **没有重复卡牌处理**
   - 同一包内可能抽到同一张卡多次（随机选取时不去重）

### 🟡 体验问题

6. **开包动画过于简陋** — 只有 emoji 抖动 + 发光，1.5 秒，远未达到"复刻实体卡包"的目标
7. **每次开包都是独立的**，没有累计统计
8. **卡图预加载无进度反馈** — 后台静默加载，用户无感知
9. **没有音效** — 开包氛围不足

### 🟢 配置/运维问题

10. **离线备用数据手动维护** — `fallback_cards.js` 有 26KB 的硬编码数据
11. **版本号散布在多处**：
    - `index.html` 页脚
    - `api.js` 文件头注释
    - `game.js` 文件头注释和 console.log
    - `style.css` 文件头注释
    - `VERSION.md`
    - 更新时容易遗漏

---

## 八、关键配置说明

### 添加新卡包

编辑 `data/cards.json`，在 `packs` 数组中添加：
```json
{
  "packId": "pack_XXX",
  "packName": "卡包中文名",
  "setCode": "YGOProDeck 上的卡包英文全名",
  "cardsPerPack": 9,
  "rarityRates": { "UR": 3, "SR": 8, "R": 20, "N": 69 },
  "guaranteedRareSlot": true
}
```

### 字段说明

| 字段 | 含义 | 示例 |
|------|------|------|
| packId | 唯一ID（不能重复） | "pack_LOB" |
| packName | 网页上显示的中文名 | "传说之蓝眼白龙" |
| setCode | YGOProDeck API 的卡包名 | "Legend of Blue Eyes White Dragon" |
| cardsPerPack | 每包抽几张卡 | 9 |
| rarityRates | 各稀有度的权重（数字越大越容易抽到） | UR:3, SR:8, R:20, N:69 |
| guaranteedRareSlot | 是否保底最后一张 R 以上 | true / false |

### 稀有度映射规则（当前实现）

| API 返回 | 映射为 |
|----------|--------|
| Ultra Rare / Secret Rare / Ultimate Rare / Ghost Rare | UR |
| Super Rare | SR |
| Rare（不含 common） | R |
| Common / 其他 | N |

### 更新版本日志

1. 编辑 `data/changelog.json`，在 `versions` 数组**最前面**添加新版本条目
2. 同步更新 `VERSION.md` 的版本历史部分

---

## 九、核心代码架构说明

### 初始化流程

```
页面加载
  → fallback_cards.js（注册离线备用数据到 window.FALLBACK_CARD_DATA）
  → api.js（注册 API 工具函数到 window.TCG_API）
  → game.js → DOMContentLoaded 事件
    → 绑定导航按钮事件
    → fetch cards.json + changelog.json
    → 渲染卡包列表
    → 绑定游戏按钮事件
```

### 开包流程

```
选择卡包 selectPack()
  → 显示 loading
  → TCG_API.getCardSetData(setCode)
    → 检查 IndexedDB 缓存
    → 缓存有效 → 返回缓存
    → 缓存失效 → 调用 API → 存入缓存
    → API 失败 → 用过期缓存 → 用离线备用数据
  → 后台预加载卡图
  → 切换到开包界面

点击开包 openPack()
  → playOpeningAnimation()（1.5秒动画）
  → drawCards()（按权重随机抽取）
    → 每张卡按 rarityRates 权重选择稀有度
    → 最后一张保底至少 R（如果 guaranteedRareSlot 为 true）
    → 结果按稀有度排序（N→R→SR→UR，稀有的放后面）
  → showResults()（展示卡牌卡图）
```

### TCG_API 暴露的接口

```javascript
window.TCG_API = {
    getCardSetData(setCode),       // 获取卡包数据（自动缓存）
    getCachedImageUrl(imageUrl),   // 获取缓存图片 URL
    preloadCardImages(cards, cb),  // 批量预加载卡图
    getCacheStatus(),              // 获取缓存状态
    clearAllCache(),               // 清除所有缓存
    refreshCardSetCache(setCode),  // 刷新指定卡包缓存
    mapRarityToCode(rarityName),   // 稀有度名称映射
    CONFIG                         // 配置常量
};
```

---

## 十、给接手 AI 的特别提醒

1. 用户是**游戏策划**，编程经验有限，请用**简单易懂的方式**沟通
2. 本项目是**纯前端项目**，不要引入后端 / Node.js / 构建工具
3. 每次版本更新后，请同时更新 `data/changelog.json` 和 `VERSION.md`
4. 遵守 YGOProDeck API 规范（≤20次/秒，卡图必须缓存，标注来源，不可商用）
5. 项目核心目标是**复刻游戏王实体卡包的开包体验**
6. 所有代码文件都有**详细的中文注释**，请保持这个风格
7. 代码中不使用 ES Module（import/export），而是通过 `window` 全局变量暴露接口
8. 项目部署在 Cloudflare Pages 上，直接推送 GitHub 即可自动部署
9. `data/cards.json` 只包含卡包配置，**不包含卡牌数据**，卡牌数据由 API 自动获取
10. 离线备用数据的卡图 URL 全部为 `null`，离线模式下显示 emoji 替代图标
